<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒœã‚¤ã‚¹ãƒã‚§ãƒ³ã‚¸ãƒ£ãƒ¼</title>
<style>
body {
  font-family: sans-serif;
  background:#111;
  color:#fff;
  text-align:center;
}
button {
  font-size:18px;
  margin:6px;
  padding:10px 16px;
  cursor:pointer;
}
</style>
</head>
<body>

<h1>ğŸ¤ ãƒœã‚¤ã‚¹ãƒã‚§ãƒ³ã‚¸ãƒ£ãƒ¼</h1>

<button onclick="start()">â–¶ ãƒã‚¤ã‚¯é–‹å§‹</button>
<button onclick="stop()">â¹ åœæ­¢</button>

<h2>ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ</h2>
<button onclick="setEffect('normal')">ãƒãƒ¼ãƒãƒ«</button>
<button onclick="setEffect('robot')">ãƒ­ãƒœãƒƒãƒˆ</button>
<button onclick="setEffect('low')">ä½ã„å£°</button>
<button onclick="setEffect('high')">é«˜ã„å£°</button>
<button onclick="setEffect('echo')">ã‚¨ã‚³ãƒ¼</button>

<script>
let audioCtx, source, stream;
let gainNode, filterNode, delayNode, osc, oscGain;

async function start() {
  stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  audioCtx = new AudioContext();

  source = audioCtx.createMediaStreamSource(stream);

  gainNode = audioCtx.createGain();
  filterNode = audioCtx.createBiquadFilter();
  delayNode = audioCtx.createDelay();
  osc = audioCtx.createOscillator();
  oscGain = audioCtx.createGain();

  // åˆæœŸè¨­å®š
  filterNode.type = "allpass";
  delayNode.delayTime.value = 0;
  osc.frequency.value = 30;
  oscGain.gain.value = 0;

  // ãƒ­ãƒœãƒƒãƒˆç”¨ï¼ˆãƒªãƒ³ã‚°ãƒ¢ã‚¸ãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  source.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  osc.connect(oscGain);
  oscGain.connect(gainNode.gain);
  osc.start();

  alert("ãƒã‚¤ã‚¯ã‚’é–‹å§‹ã—ã¾ã—ãŸ");
}

function stop() {
  stream.getTracks().forEach(t => t.stop());
  audioCtx.close();
  alert("ãƒã‚¤ã‚¯ã‚’åœæ­¢ã—ã¾ã—ãŸ");
}

function setEffect(type) {
  gainNode.disconnect();
  filterNode.disconnect();
  delayNode.disconnect();

  if (type === "normal") {
    source.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    oscGain.gain.value = 0;
  }

  if (type === "robot") {
    source.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    oscGain.gain.value = 0.8;
  }

  if (type === "low") {
    filterNode.type = "lowshelf";
    filterNode.frequency.value = 400;
    filterNode.gain.value = 15;
    source.connect(filterNode);
    filterNode.connect(audioCtx.destination);
    oscGain.gain.value = 0;
  }

  if (type === "high") {
    filterNode.type = "highshelf";
    filterNode.frequency.value = 1000;
    filterNode.gain.value = 15;
    source.connect(filterNode);
    filterNode.connect(audioCtx.destination);
    oscGain.gain.value = 0;
  }

  if (type === "echo") {
    delayNode.delayTime.value = 0.25;
    source.connect(delayNode);
    delayNode.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    oscGain.gain.value = 0;
  }
}
</script>

</body>
</html>
