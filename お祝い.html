<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‰ è‡ªå‹•èµ·å‹•QRã‚¹ã‚­ãƒ£ãƒ³ï¼†èª•ç”Ÿæ—¥ãŠç¥ã„ã‚µã‚¤ãƒˆ ğŸ‰</title>
    <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    <style>
        /* ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #fce4ec; /* è–„ã„ãƒ”ãƒ³ã‚¯ã®èƒŒæ™¯ */
            color: #333;
            text-align: center;
            padding: 20px;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            width: 90%;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        /* --- ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #scanner-view {
            display: block;
        }
        #preview-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            height: 300px;
            margin: 20px auto;
            background-color: #333;
            border-radius: 8px;
            overflow: hidden;
        }
        #preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #scan-status {
            margin-top: 15px;
            padding: 10px;
            border: 2px dashed #e91e63;
            min-height: 40px;
            word-wrap: break-word;
            text-align: left;
            background-color: #fff8e1;
            transition: background-color 0.3s;
        }
        .success-bg { background-color: #e8f5e9; }
        .error-text { color: red; font-weight: bold; }
        .info-text { color: #00bcd4; }

        /* --- èª•ç”Ÿæ—¥ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #birthday-view {
            display: none; /* åˆæœŸã¯éè¡¨ç¤º */
        }
        h1 {
            color: #e91e63;
            font-size: 3em;
            margin-bottom: 10px;
        }
        #nameDisplay { 
            color: #00bcd4; 
            font-size: 2.5em; 
            margin-bottom: 20px; 
            font-weight: bold; 
        } 
        .message { 
            font-size: 1.2em; 
            line-height: 1.6; 
            margin-bottom: 30px; 
            text-align: left; 
            padding: 0 20px; 
        }
        .photo-area img { 
            max-width: 100%; 
            height: auto; 
            border-radius: 10px; 
            border: 5px solid #ffc107; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .sender { 
            font-size: 1.1em; 
            font-weight: bold; 
            color: #e91e63; 
            text-align: right; 
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="scanner-view">
            <h2>QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ã„ã¾ã™...</h2>
            <p class="info-text">ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’æ±‚ã‚ã‚‰ã‚ŒãŸã‚‰ã€Œè¨±å¯ã€ã—ã¦ãã ã•ã„ã€‚</p>

            <div id="preview-container">
                <video id="preview"></video>
                </div>

            <h3>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</h3>
            <p id="scan-status">ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã‚’å¾…ã£ã¦ã„ã¾ã™ã€‚</p>
        </div>

        <div id="birthday-view">
            
            <h1 class="birthday-text">ãŠèª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†ï¼</h1>

            <div id="nameDisplay">ç´ æ•µãªã‚ãªãŸã¸ï¼</div> 
            
            <div class="photo-area">
                <img src="birthday_photo.jpg" alt="ãŠç¥ã„ã®å†™çœŸ" width="400">
            </div>

            <div class="message">
                <p><strong>ã“ã®ç‰¹åˆ¥ãªæ—¥ã‚’å¿ƒã‹ã‚‰ãŠç¥ã„ã§ãã¦ã€æœ¬å½“ã«å¬‰ã—ã„ã§ã™ã€‚</strong></p>
                <p>æ–°ã—ã„ä¸€å¹´ãŒã€ã‚ãªãŸã«ã¨ã£ã¦å¥åº·ã¨å–œã³ã«æº€ã¡ãŸã€ç´ æ™´ã‚‰ã—ã„æ—¥ã€…ã«ãªã‚Šã¾ã™ã‚ˆã†ã«ï¼</p>
                <p>ã“ã‚Œã‹ã‚‰ã‚‚ãšã£ã¨ã€ç´ æ•µãªç¬‘é¡”ã‚’è¦‹ã›ã¦ã­ã€‚å¿ƒã‹ã‚‰æ„›ã‚’è¾¼ã‚ã¦ã€‚</p>
            </div>

            <div class="sender">
                <p>â–³â–³ã‚ˆã‚Š</p>
            </div>

        </div>

    </div>

    <script>
        const scannerView = document.getElementById('scanner-view');
        const birthdayView = document.getElementById('birthday-view');
        const preview = document.getElementById('preview');
        const scanStatus = document.getElementById('scan-status');
        const nameDisplay = document.getElementById('nameDisplay');
        
        let scanner = null;
        let isProcessing = false;

        /**
         * å³æ ¼ãªæ­£è¦è¡¨ç¾ã§åå‰ã‚’æŠ½å‡ºã€‚name=ã€‡ã€‡ ã®å½¢å¼ã®ã¿ã‚’è¨±å¯ã€‚
         */
        function extractNameStrict(data) {
            // æ­£è¦è¡¨ç¾: æ–‡å­—åˆ—å…¨ä½“ãŒ "name=" ã§å§‹ã¾ã‚Šã€ãã®å¾Œã«1æ–‡å­—ä»¥ä¸ŠãŒç¶šãã“ã¨ã‚’è¦æ±‚ã€‚
            const match = data.match(/^name=(.+)$/); 
            
            if (match && match[1].trim() !== '') {
                return match[1].trim(); 
            }
            return null;
        }

        function checkAndProcessScan(content) {
            if (isProcessing) return;
            
            const extractedName = extractNameStrict(content);

            if (extractedName) {
                isProcessing = true;
                scanStatus.classList.add('success-bg');
                scanStatus.innerHTML = `âœ… **æœ‰åŠ¹ãªã‚³ãƒ¼ãƒ‰ãŒèª­ã¿å–ã‚‰ã‚Œã¾ã—ãŸï¼**<br>åå‰: ${extractedName}ã€‚ãŠç¥ã„ç”»é¢ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™...`;
                
                // 1. ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’åœæ­¢
                if (scanner) scanner.stop();

                // 2. DOMã‚’æ›¸ãæ›ãˆã¦åå‰ã‚’ã‚»ãƒƒãƒˆ
                nameDisplay.textContent = `${extractedName}ã•ã‚“ã¸ï¼`;
                
                // 3. 2ç§’å¾Œã«ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆ
                setTimeout(() => {
                    scannerView.style.display = 'none';
                    birthdayView.style.display = 'block';
                }, 2000); 

            } else {
                scanStatus.innerHTML = `<span class="error-text">âŒ ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã™ã€‚</span><br>ã‚³ãƒ¼ãƒ‰å…¨ä½“ãŒã€Œname=åå‰ã€ã®**å³å¯†ãª**å½¢å¼ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ï¼ˆä¾‹: name=ãŸã‚ã†ï¼‰`;
            }
        }

        function startScanner() {
            // Instascan.Scannerã®åˆæœŸåŒ–
            scanner = new Instascan.Scanner({ video: preview, scanPeriod: 5 });
            scanner.addListener('scan', checkAndProcessScan);

            Instascan.Camera.getCameras().then(function (cameras) {
                if (cameras.length > 0) {
                    // é€šå¸¸ã€ãƒ‡ãƒã‚¤ã‚¹ã®æœ€åˆã®ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨
                    scanner.start(cameras[0]); 
                    scanStatus.textContent = 'ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚QRã‚³ãƒ¼ãƒ‰ã‚’ã‹ã–ã—ã¦ãã ã•ã„ã€‚';
                } else {
                    scanStatus.innerHTML = '<span class="error-text">ã‚¨ãƒ©ãƒ¼: åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</span>';
                }
            }).catch(function (e) {
                scanStatus.innerHTML = `<span class="error-text">ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼:</span> ${e.name}`;
            });
        }
        
        // --- ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«è‡ªå‹•ã§ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹ ---
        window.addEventListener('load', startScanner);

        // ãƒšãƒ¼ã‚¸ãŒé–‰ã˜ã‚‰ã‚Œã‚‹ã¨ãã«ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢
        window.addEventListener('beforeunload', () => {
            if (scanner) {
                scanner.stop();
            }
        });
    </script>
</body>
</html>
