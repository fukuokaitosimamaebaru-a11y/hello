<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>çˆ†éŸ³ãƒ›ãƒ¼ãƒ«ãƒã‚¤ã‚¯</title>
<style>
body {
  background:#000;
  color:#0f0;
  font-family:sans-serif;
  text-align:center;
}
.box {
  border:2px solid #0f0;
  padding:15px;
  max-width:420px;
  margin:auto;
}
input, select, button {
  font-size:16px;
  margin:8px;
}
.warning {
  color:red;
  font-weight:bold;
}
</style>
</head>
<body>

<h1>ğŸ”Š çˆ†éŸ³ãƒ›ãƒ¼ãƒ«ãƒã‚¤ã‚¯</h1>
<div class="warning">âš  ãƒã‚¦ãƒªãƒ³ã‚°æ³¨æ„ / éŸ³é‡æ³¨æ„</div>

<div class="box">
  <div>
    ãƒã‚¤ã‚¯é¸æŠ<br>
    <select id="micSelect"></select>
  </div>

  <div>
    ãƒªãƒãƒ¼ãƒ–é‡<br>
    <input type="range" id="reverb" min="0" max="1" step="0.01" value="0.6">
  </div>

  <div>
    çˆ†éŸ³ãƒ¬ãƒ™ãƒ«ï¼ˆå±é™ºï¼‰<br>
    <input type="range" id="boost" min="1" max="15" step="0.1" value="6">
  </div>

  <button id="start">â–¶ é–‹å§‹</button>
  <button id="stop">â¹ åœæ­¢</button>
</div>

<script>
let audioContext, stream, source;
let convolver, reverbGain, boostGain;

function createReverb(ctx, duration=4, decay=2.5) {
  const rate = ctx.sampleRate;
  const length = rate * duration;
  const buffer = ctx.createBuffer(2, length, rate);

  for (let c=0;c<2;c++) {
    const data = buffer.getChannelData(c);
    for (let i=0;i<length;i++) {
      data[i] = (Math.random()*2-1)*Math.pow(1-i/length,decay);
    }
  }
  return buffer;
}

async function loadMics() {
  await navigator.mediaDevices.getUserMedia({audio:true});
  const devices = await navigator.mediaDevices.enumerateDevices();
  const select = document.getElementById("micSelect");
  select.innerHTML="";
  devices.filter(d=>d.kind==="audioinput").forEach(d=>{
    const o=document.createElement("option");
    o.value=d.deviceId;
    o.textContent=d.label||"ä¸æ˜ãªãƒã‚¤ã‚¯";
    select.appendChild(o);
  });
}

async function startAudio() {
  audioContext = new AudioContext();

  stream = await navigator.mediaDevices.getUserMedia({
    audio:{deviceId:{exact:micSelect.value}}
  });

  source = audioContext.createMediaStreamSource(stream);

  convolver = audioContext.createConvolver();
  convolver.buffer = createReverb(audioContext);

  reverbGain = audioContext.createGain();
  boostGain = audioContext.createGain();

  reverbGain.gain.value = reverb.value;
  boostGain.gain.value = boost.value;

  source.connect(convolver);
  convolver.connect(reverbGain);
  reverbGain.connect(boostGain);
  boostGain.connect(audioContext.destination);
}

function stopAudio() {
  if(stream) stream.getTracks().forEach(t=>t.stop());
  if(audioContext) audioContext.close();
  alert("ãƒã‚¤ã‚¯ã‚’åœæ­¢ã—ã¾ã—ãŸ");
}

reverb.oninput = ()=> reverbGain && (reverbGain.gain.value = reverb.value);
boost.oninput  = ()=> boostGain && (boostGain.gain.value  = boost.value);

start.onclick = startAudio;
stop.onclick = stopAudio;

loadMics();
</script>
</body>
</html>
